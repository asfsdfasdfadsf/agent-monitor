<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Monitor</title>
<style>
  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #1c2333;
    --bg-hover: #1f2937;
    --border: #30363d;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent-blue: #58a6ff;
    --accent-green: #3fb950;
    --accent-orange: #d29922;
    --accent-red: #f85149;
    --accent-purple: #bc8cff;
    --accent-cyan: #39d2c0;
    --accent-pink: #f778ba;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
    background: var(--bg-primary); color: var(--text-primary);
    height: 100vh; overflow: hidden;
  }

  /* ── Top Bar ───────────────────────────────── */
  .topbar {
    height: 48px; background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 16px; gap: 16px;
  }
  .topbar-logo {
    display: flex; align-items: center; gap: 8px;
    font-weight: 700; font-size: 14px; color: var(--accent-blue); white-space: nowrap;
  }
  .topbar-logo .dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green);
    animation: pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(63,185,80,0.4); }
    50% { opacity:0.7; box-shadow: 0 0 0 6px rgba(63,185,80,0); }
  }
  .topbar-stats {
    display: flex; gap: 20px; margin-left: auto; font-size: 12px; color: var(--text-secondary);
  }
  .topbar-stats span { display: flex; align-items: center; gap: 4px; }
  .stat-value { color: var(--text-primary); font-weight: 600; }
  .live-indicator {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--accent-green);
    animation: fade-live 3s ease-in-out infinite;
  }
  @keyframes fade-live { 0%,100%{opacity:1} 50%{opacity:0.5} }

  /* ── Layout ────────────────────────────────── */
  .layout {
    display: grid; grid-template-columns: 280px 1fr 1fr 260px;
    height: calc(100vh - 48px);
  }
  .panel {
    overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .panel::-webkit-scrollbar { width: 6px; }
  .panel::-webkit-scrollbar-track { background: transparent; }
  .panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .panel-header {
    position: sticky; top: 0; z-index: 10;
    background: var(--bg-secondary); border-bottom: 1px solid var(--border);
    padding: 10px 14px; font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary);
    display: flex; align-items: center; gap: 8px;
  }
  .panel-header .count {
    background: var(--bg-tertiary); border-radius: 10px;
    padding: 1px 8px; font-size: 10px; color: var(--text-muted);
  }

  /* ── Timeline (Left) ───────────────────────── */
  .timeline-panel { background: var(--bg-secondary); border-right: 1px solid var(--border); }
  .timeline-item {
    padding: 8px 14px; border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.15s; position: relative;
  }
  .timeline-item:hover { background: var(--bg-hover); }
  .timeline-item.active { background: var(--bg-tertiary); border-left: 3px solid var(--accent-blue); }
  .tl-top { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
  .tl-icon {
    width: 22px; height: 22px; border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; flex-shrink: 0;
  }
  .tl-tool { font-size: 11px; font-weight: 600; }
  .tl-phase { font-size: 9px; color: var(--text-muted); padding: 1px 5px; border-radius: 3px; background: var(--bg-tertiary); }
  .tl-time { font-size: 10px; color: var(--text-muted); margin-left: auto; white-space: nowrap; }
  .tl-summary {
    font-size: 10px; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 30px;
  }

  .tool-Read .tl-icon    { background: rgba(88,166,255,0.15); color: var(--accent-blue); }
  .tool-Edit .tl-icon    { background: rgba(210,153,34,0.15); color: var(--accent-orange); }
  .tool-Write .tl-icon   { background: rgba(63,185,80,0.15); color: var(--accent-green); }
  .tool-Bash .tl-icon    { background: rgba(248,81,73,0.15); color: var(--accent-red); }
  .tool-Grep .tl-icon    { background: rgba(188,140,255,0.15); color: var(--accent-purple); }
  .tool-Glob .tl-icon    { background: rgba(188,140,255,0.15); color: var(--accent-purple); }
  .tool-Task .tl-icon    { background: rgba(57,210,192,0.15); color: var(--accent-cyan); }
  .tool-WebFetch .tl-icon { background: rgba(247,120,186,0.15); color: var(--accent-pink); }
  .tool-WebSearch .tl-icon { background: rgba(247,120,186,0.15); color: var(--accent-pink); }
  .tool-default .tl-icon { background: rgba(139,148,158,0.15); color: var(--text-secondary); }
  .tool-Read .tl-tool    { color: var(--accent-blue); }
  .tool-Edit .tl-tool    { color: var(--accent-orange); }
  .tool-Write .tl-tool   { color: var(--accent-green); }
  .tool-Bash .tl-tool    { color: var(--accent-red); }
  .tool-Grep .tl-tool    { color: var(--accent-purple); }
  .tool-Glob .tl-tool    { color: var(--accent-purple); }
  .tool-Task .tl-tool    { color: var(--accent-cyan); }
  .tool-WebFetch .tl-tool { color: var(--accent-pink); }
  .tool-WebSearch .tl-tool { color: var(--accent-pink); }

  /* ── Center: Live Viewer ───────────────────── */
  .viewer-panel { background: var(--bg-primary); display: flex; flex-direction: column; }
  .viewer-content {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .viewer-content::-webkit-scrollbar { width: 6px; }
  .viewer-content::-webkit-scrollbar-track { background: transparent; }
  .viewer-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── Viewer: Code Editor ───────────────────── */
  .viewer-code { flex: 1; display: flex; flex-direction: column; }
  .code-titlebar {
    display: flex; align-items: center; gap: 0;
    background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
    min-height: 36px;
  }
  .code-tab {
    padding: 8px 16px; font-size: 12px; color: var(--text-secondary);
    border-right: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
  }
  .code-tab.active {
    background: var(--bg-primary); color: var(--text-primary);
    border-bottom: 2px solid var(--accent-blue); margin-bottom: -1px;
  }
  .code-tab-icon { font-size: 10px; }
  .code-action-label {
    margin-left: auto; padding: 0 14px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .code-body {
    flex: 1; overflow: auto; padding: 0; font-size: 12px; line-height: 1.7;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .code-body::-webkit-scrollbar { width: 6px; }
  .code-body::-webkit-scrollbar-track { background: transparent; }
  .code-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .code-line {
    display: flex; min-height: 20px; padding-right: 16px;
  }
  .code-line:hover { background: rgba(255,255,255,0.02); }
  .code-linenum {
    width: 50px; text-align: right; padding-right: 16px;
    color: var(--text-muted); user-select: none; flex-shrink: 0; font-size: 11px;
  }
  .code-text { white-space: pre-wrap; word-break: break-all; flex: 1; }
  .code-line.diff-add { background: rgba(63,185,80,0.1); }
  .code-line.diff-add .code-text { color: var(--accent-green); }
  .code-line.diff-del { background: rgba(248,81,73,0.1); }
  .code-line.diff-del .code-text { color: var(--accent-red); text-decoration: line-through; }
  .code-line.highlight { background: rgba(88,166,255,0.08); }

  /* syntax: basic keyword coloring */
  .syn-kw { color: var(--accent-red); }
  .syn-str { color: var(--accent-green); }
  .syn-num { color: var(--accent-orange); }
  .syn-cm { color: var(--text-muted); font-style: italic; }
  .syn-fn { color: var(--accent-purple); }
  .syn-op { color: var(--accent-cyan); }

  /* ── Viewer: Terminal ──────────────────────── */
  .viewer-terminal { flex: 1; display: flex; flex-direction: column; }
  .term-titlebar {
    display: flex; align-items: center; gap: 8px;
    background: #1a1a2e; border-bottom: 1px solid #333;
    padding: 8px 14px; min-height: 36px;
  }
  .term-dots { display: flex; gap: 6px; }
  .term-dots span { width: 10px; height: 10px; border-radius: 50%; }
  .term-dots .d-r { background: #ff5f56; }
  .term-dots .d-y { background: #ffbd2e; }
  .term-dots .d-g { background: #27c93f; }
  .term-title { font-size: 11px; color: #888; margin-left: 8px; }
  .term-body {
    flex: 1; background: #0a0a1a; padding: 14px 16px; overflow: auto;
    font-size: 12px; line-height: 1.7;
    scrollbar-width: thin; scrollbar-color: #333 transparent;
  }
  .term-body::-webkit-scrollbar { width: 6px; }
  .term-body::-webkit-scrollbar-track { background: transparent; }
  .term-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  .term-prompt { color: var(--accent-green); }
  .term-cmd { color: #fff; font-weight: 600; }
  .term-output { color: #aaa; white-space: pre-wrap; word-break: break-all; }
  .term-cursor {
    display: inline-block; width: 8px; height: 14px; background: var(--accent-green);
    animation: blink-cursor 1s step-end infinite; vertical-align: middle; margin-left: 2px;
  }
  @keyframes blink-cursor { 0%,100%{opacity:1} 50%{opacity:0} }

  /* ── Viewer: Browser ───────────────────────── */
  .viewer-browser { flex: 1; display: flex; flex-direction: column; }
  .browser-chrome {
    background: #2b2b3d; border-bottom: 1px solid #444;
    padding: 8px 12px; display: flex; flex-direction: column; gap: 6px;
  }
  .browser-controls { display: flex; align-items: center; gap: 8px; }
  .browser-nav-btn {
    width: 28px; height: 28px; border-radius: 6px; border: none;
    background: rgba(255,255,255,0.08); color: #888; font-size: 14px;
    cursor: default; display: flex; align-items: center; justify-content: center;
  }
  .browser-url-bar {
    flex: 1; background: #1a1a2e; border: 1px solid #444; border-radius: 20px;
    padding: 6px 14px; font-size: 12px; color: var(--text-primary);
    font-family: inherit; display: flex; align-items: center; gap: 8px;
  }
  .browser-url-bar .lock { color: var(--accent-green); font-size: 11px; }
  .browser-url-bar .url { color: var(--text-secondary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .browser-url-bar .url .domain { color: var(--text-primary); }
  .browser-body {
    flex: 1; background: #fff; overflow: auto; padding: 20px;
    color: #222; font-family: Arial, Helvetica, sans-serif;
    scrollbar-width: thin;
  }
  .browser-body::-webkit-scrollbar { width: 6px; }
  .browser-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
  .search-logo { text-align: center; margin-bottom: 20px; }
  .search-logo span { font-size: 42px; font-weight: 700; }
  .search-logo .s-b { color: #4285f4; }
  .search-logo .s-r { color: #ea4335; }
  .search-logo .s-y { color: #fbbc05; }
  .search-logo .s-g { color: #34a853; }
  .search-bar-fake {
    max-width: 560px; margin: 0 auto 24px; padding: 10px 18px;
    border: 1px solid #ddd; border-radius: 24px;
    font-size: 15px; color: #222; font-family: Arial, sans-serif;
  }
  .search-result { margin-bottom: 20px; max-width: 600px; }
  .search-result .sr-url { font-size: 12px; color: #202124; margin-bottom: 2px; }
  .search-result .sr-title { font-size: 18px; color: #1a0dab; margin-bottom: 4px; cursor: pointer; }
  .search-result .sr-title:hover { text-decoration: underline; }
  .search-result .sr-desc { font-size: 13px; color: #545454; line-height: 1.5; }
  .search-result .sr-desc em { color: #222; font-style: normal; font-weight: 600; }

  /* ── Viewer: Search (Grep/Glob) ────────────── */
  .viewer-search { flex: 1; display: flex; flex-direction: column; }
  .search-titlebar {
    background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
    padding: 10px 16px; display: flex; align-items: center; gap: 10px;
  }
  .search-input-fake {
    flex: 1; background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 6px; padding: 6px 12px; font-size: 12px;
    color: var(--accent-purple); font-family: inherit;
    display: flex; align-items: center; gap: 8px;
  }
  .search-input-fake .si-icon { color: var(--text-muted); }
  .search-scope { font-size: 10px; color: var(--text-muted); padding: 3px 8px; background: var(--bg-primary); border-radius: 4px; }
  .search-body { flex: 1; overflow: auto; padding: 12px 0; }
  .search-file-group { margin-bottom: 12px; }
  .search-file-path {
    padding: 4px 16px; font-size: 11px; color: var(--accent-blue);
    background: rgba(88,166,255,0.05);
  }
  .search-match-line {
    padding: 2px 16px; font-size: 12px; display: flex; gap: 12px;
  }
  .search-match-line:hover { background: var(--bg-hover); }
  .sml-num { color: var(--text-muted); width: 40px; text-align: right; flex-shrink: 0; }
  .sml-text { white-space: pre-wrap; word-break: break-all; }
  .sml-text .match-hl { background: rgba(188,140,255,0.25); color: var(--accent-purple); padding: 1px 2px; border-radius: 2px; }

  /* ── Viewer: Agent/Task ────────────────────── */
  .viewer-agent { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; padding: 40px; }
  .agent-orb {
    width: 64px; height: 64px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent-cyan), var(--accent-blue));
    animation: agent-pulse 2s ease-in-out infinite;
  }
  @keyframes agent-pulse {
    0%,100% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.08); opacity: 0.9; }
  }
  .agent-label { font-size: 12px; color: var(--text-secondary); text-align: center; max-width: 400px; }
  .agent-desc { font-size: 14px; color: var(--text-primary); font-weight: 600; text-align: center; }

  /* ── Viewer: Idle ──────────────────────────── */
  .viewer-idle {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
  }
  .idle-orb {
    width: 80px; height: 80px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent-blue), var(--accent-purple));
    opacity: 0.15; animation: breathe 4s ease-in-out infinite;
  }
  @keyframes breathe { 0%,100%{transform:scale(1);opacity:0.15} 50%{transform:scale(1.1);opacity:0.3} }
  .idle-text { font-size: 13px; color: var(--text-muted); }

  /* ── Sidebar (Right) ───────────────────────── */
  .sidebar-panel { background: var(--bg-secondary); border-left: 1px solid var(--border); }
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px 14px; }
  .stat-card { background: var(--bg-tertiary); border-radius: 8px; padding: 8px; text-align: center; }
  .stat-card-value { font-size: 18px; font-weight: 800; color: var(--text-primary); }
  .stat-card-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-top: 2px; }
  /* ── Usage Meter ──────────────────────────── */
  .usage-section { padding: 10px 14px; }
  .usage-ring-row { display: flex; align-items: center; gap: 14px; margin-bottom: 10px; }
  .usage-ring-wrap { position: relative; width: 72px; height: 72px; flex-shrink: 0; }
  .usage-ring-wrap svg { transform: rotate(-90deg); }
  .usage-ring-bg { fill: none; stroke: var(--bg-primary); stroke-width: 6; }
  .usage-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
  .usage-ring-center {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .usage-ring-value { font-size: 14px; font-weight: 800; color: var(--text-primary); line-height: 1; }
  .usage-ring-unit { font-size: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .usage-breakdown { flex: 1; min-width: 0; }
  .usage-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 10px; padding: 2px 0; border-bottom: 1px solid rgba(48,54,61,0.3);
  }
  .usage-row:last-child { border-bottom: none; }
  .usage-row-label { color: var(--text-secondary); }
  .usage-row-value { color: var(--text-primary); font-weight: 600; font-variant-numeric: tabular-nums; }
  .usage-model-badge {
    display: inline-block; font-size: 9px; padding: 2px 8px; border-radius: 4px;
    background: rgba(88,166,255,0.1); color: var(--accent-blue); font-weight: 600;
    letter-spacing: 0.3px;
  }
  .usage-cost {
    font-size: 18px; font-weight: 800; color: var(--accent-green);
    text-align: center; margin-top: 4px;
  }
  .usage-cost-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; text-align: center; }

  .tool-bar-chart { padding: 8px 14px; }
  .tool-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 11px; }
  .tool-bar-name { width: 65px; text-align: right; color: var(--text-secondary); flex-shrink: 0; font-size: 10px; }
  .tool-bar-track { flex: 1; height: 12px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; }
  .tool-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
  .tool-bar-count { width: 24px; font-size: 10px; color: var(--text-muted); }
  .file-tree-item {
    padding: 5px 14px; font-size: 10px; display: flex; align-items: center; gap: 6px;
    color: var(--text-secondary); border-bottom: 1px solid rgba(48,54,61,0.5);
  }
  .file-tree-item .ft-icon { font-size: 9px; flex-shrink: 0; }
  .file-tree-item .ft-path { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: rtl; text-align: left; }
  .file-tree-item.ft-read .ft-icon { color: var(--accent-blue); }
  .file-tree-item.ft-write .ft-icon { color: var(--accent-green); }

  /* ── Conversation Panel ──────────────────────── */
  .chat-panel {
    background: var(--bg-secondary); border-left: 1px solid var(--border);
    display: flex; flex-direction: column; overflow: hidden;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 12px;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    display: flex; flex-direction: column; gap: 10px;
  }
  .chat-messages::-webkit-scrollbar { width: 6px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .chat-msg {
    max-width: 92%; padding: 10px 14px; border-radius: 12px;
    font-size: 12px; line-height: 1.6; word-break: break-word;
    position: relative;
  }
  .chat-msg.user {
    align-self: flex-end;
    background: rgba(88,166,255,0.12); border: 1px solid rgba(88,166,255,0.2);
    border-bottom-right-radius: 4px;
  }
  .chat-msg.assistant {
    align-self: flex-start;
    background: var(--bg-tertiary); border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }
  .chat-msg-role {
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 4px;
  }
  .chat-msg.user .chat-msg-role { color: var(--accent-blue); }
  .chat-msg.assistant .chat-msg-role { color: var(--accent-purple); }
  .chat-msg-text { color: var(--text-primary); white-space: pre-wrap; }
  .chat-msg-text code {
    background: rgba(255,255,255,0.06); padding: 1px 5px; border-radius: 3px;
    font-size: 11px;
  }
  .chat-msg-text pre {
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 10px; margin: 6px 0;
    overflow-x: auto; font-size: 11px; line-height: 1.5;
  }
  .chat-msg-time {
    font-size: 9px; color: var(--text-muted); margin-top: 4px; text-align: right;
  }
  .chat-typing {
    align-self: flex-start; padding: 10px 14px;
    background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 12px; border-bottom-left-radius: 4px;
    display: flex; gap: 4px; align-items: center;
  }
  .chat-typing-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted);
    animation: typing-bounce 1.4s ease-in-out infinite;
  }
  .chat-typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .chat-typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing-bounce {
    0%,60%,100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-4px); opacity: 1; }
  }
  .chat-empty {
    flex: 1; display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); font-size: 12px;
  }

  /* ── Auto-follow toggle ────────────────────── */
  .auto-follow-btn {
    padding: 3px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;
    border: 1px solid var(--border); background: transparent; color: var(--text-muted);
    font-family: inherit; margin-left: auto;
  }
  .auto-follow-btn.active { background: rgba(63,185,80,0.15); color: var(--accent-green); border-color: var(--accent-green); }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo"><div class="dot"></div> Agent Monitor</div>
  <div class="topbar-stats">
    <span>Events: <span class="stat-value" id="stat-total">0</span></span>
    <span>Files: <span class="stat-value" id="stat-files">0</span></span>
    <span>Session: <span class="stat-value" id="stat-uptime">0s</span></span>
    <span class="live-indicator">LIVE</span>
    <span id="dbg" style="font-size:10px;color:var(--accent-orange);">Starting...</span>
  </div>
</div>

<div class="layout">
  <!-- Left: Timeline -->
  <div class="panel timeline-panel">
    <div class="panel-header">
      Timeline <span class="count" id="timeline-count">0</span>
      <button class="auto-follow-btn active" id="auto-follow-btn" onclick="toggleAutoFollow()">Auto-follow</button>
    </div>
    <div id="timeline"></div>
  </div>

  <!-- Center-Left: Live Viewer -->
  <div class="viewer-panel">
    <div class="panel-header">Live Viewer</div>
    <div class="viewer-content" id="viewer"></div>
  </div>

  <!-- Center-Right: Conversation -->
  <div class="chat-panel">
    <div class="panel-header">Conversation <span class="count" id="chat-count">0</span></div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-empty">Waiting for conversation...</div>
    </div>
  </div>

  <!-- Right: Sidebar -->
  <div class="panel sidebar-panel">
    <div class="panel-header">Stats</div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-card-value" id="sc-reads">0</div><div class="stat-card-label">Reads</div></div>
      <div class="stat-card"><div class="stat-card-value" id="sc-writes">0</div><div class="stat-card-label">Writes</div></div>
      <div class="stat-card"><div class="stat-card-value" id="sc-bash">0</div><div class="stat-card-label">Commands</div></div>
      <div class="stat-card"><div class="stat-card-value" id="sc-searches">0</div><div class="stat-card-label">Searches</div></div>
    </div>
    <div class="panel-header">Token Usage</div>
    <div class="usage-section" id="usage-section">
      <div style="text-align:center;color:var(--text-muted);font-size:11px;padding:8px 0;">Waiting for data...</div>
    </div>
    <div class="panel-header">Tool Usage</div>
    <div class="tool-bar-chart" id="tool-chart"></div>
    <div class="panel-header">Files Touched <span class="count" id="files-count">0</span></div>
    <div id="file-tree"></div>
  </div>
</div>

<script>
const TOOL_ICONS = {
  Read:'&#128196;', Edit:'&#9998;', Write:'&#128190;', Bash:'&#9002;',
  Grep:'&#128269;', Glob:'&#128193;', Task:'&#9881;', WebFetch:'&#127760;',
  WebSearch:'&#127760;', NotebookEdit:'&#128211;', AskUserQuestion:'&#10067;',
};
const TOOL_COLORS = {
  Read:'var(--accent-blue)', Edit:'var(--accent-orange)', Write:'var(--accent-green)',
  Bash:'var(--accent-red)', Grep:'var(--accent-purple)', Glob:'var(--accent-purple)',
  Task:'var(--accent-cyan)', WebFetch:'var(--accent-pink)', WebSearch:'var(--accent-pink)',
};

let allEvents = [];
let activeEvent = null;  // currently displayed event
let pinned = false;      // if user clicked a timeline item
let autoFollow = true;
let toolCounts = {};
let filesRead = new Set();
let filesWritten = new Set();
let sessionStart = null;

// ── Connection ──────────────────────────────
async function connect() {
  const dbg = document.getElementById('dbg');
  try {
    dbg.textContent = 'Fetching events...';
    const res = await fetch('/api/events');
    const data = await res.json();
    dbg.textContent = 'Got ' + data.events.length + ' events, rendering...';
    data.events.forEach(addEvent);
    if (allEvents.length) { activeEvent = allEvents[allEvents.length - 1]; }
    render();
    dbg.textContent = 'Rendered ' + allEvents.length + ' events. Connecting SSE...';
  } catch (e) {
    dbg.textContent = 'ERROR loading events: ' + e.message;
    console.error('Init failed:', e);
    return;
  }

  try {
    const evtSource = new EventSource('/api/stream');
    evtSource.onopen = () => { dbg.textContent = 'Live (' + allEvents.length + ' events)'; };
    evtSource.onmessage = (msg) => {
      try {
        const evt = JSON.parse(msg.data);
        if (allEvents.find(e => e.id === evt.id)) return;
        addEvent(evt);
        if (autoFollow && !pinned) activeEvent = evt;
        render();
        dbg.textContent = 'Live (' + allEvents.length + ' events)';
      } catch(e) {
        dbg.textContent = 'SSE parse error: ' + e.message;
      }
    };
    evtSource.onerror = () => { dbg.textContent = 'SSE reconnecting...'; };
  } catch(e) {
    dbg.textContent = 'SSE error: ' + e.message;
  }
}

function addEvent(evt) {
  allEvents.push(evt);
  if (!sessionStart) sessionStart = evt.timestamp;
  const tool = evt.tool_name || 'unknown';
  toolCounts[tool] = (toolCounts[tool] || 0) + 1;
  const input = evt.tool_input || {};
  if (tool === 'Read' && input.file_path) filesRead.add(input.file_path);
  if ((tool === 'Edit' || tool === 'Write') && input.file_path) filesWritten.add(input.file_path);
}

function toggleAutoFollow() {
  autoFollow = !autoFollow;
  pinned = false;
  document.getElementById('auto-follow-btn').classList.toggle('active', autoFollow);
  if (autoFollow && allEvents.length) {
    activeEvent = allEvents[allEvents.length - 1];
    render();
  }
}

// ── Rendering ───────────────────────────────
function render() {
  try {
    renderTimeline();
    renderViewer();
    renderStats();
    renderToolChart();
    renderFileTree();
  } catch(e) {
    console.error('Render error:', e);
    document.getElementById('dbg').textContent = 'RENDER ERROR: ' + e.message + ' at ' + e.stack?.split('\n')[1]?.trim();
  }
}

function renderTimeline() {
  const el = document.getElementById('timeline');
  document.getElementById('timeline-count').textContent = allEvents.length;
  const visible = allEvents.slice(-200).reverse();
  el.innerHTML = visible.map(evt => {
    const tool = evt.tool_name || 'unknown';
    const cls = TOOL_ICONS[tool] ? `tool-${tool}` : 'tool-default';
    const icon = TOOL_ICONS[tool] || '&#9670;';
    const time = formatTime(evt.timestamp);
    const summary = getEventSummary(evt);
    const isActive = activeEvent && activeEvent.id === evt.id ? ' active' : '';
    const phase = evt.hook_type === 'PreToolUse' ? 'pre' : '';
    return `<div class="timeline-item ${cls}${isActive}" data-id="${evt.id}">
      <div class="tl-top">
        <div class="tl-icon">${icon}</div>
        <div class="tl-tool">${tool}</div>
        ${phase ? '<span class="tl-phase">pre</span>' : ''}
        <div class="tl-time">${time}</div>
      </div>
      <div class="tl-summary">${esc(summary)}</div>
    </div>`;
  }).join('');
  el.querySelectorAll('.timeline-item').forEach(item => {
    item.onclick = () => {
      const evt = allEvents.find(e => e.id === item.dataset.id);
      if (evt) { activeEvent = evt; pinned = true; render(); }
    };
  });
}

// ── Live Viewer ─────────────────────────────
function renderViewer() {
  const el = document.getElementById('viewer');
  if (!activeEvent) {
    el.innerHTML = `<div class="viewer-idle"><div class="idle-orb"></div><div class="idle-text">Waiting for agent activity...</div></div>`;
    return;
  }
  const evt = activeEvent;
  const tool = evt.tool_name || 'unknown';
  const input = evt.tool_input || {};

  if (tool === 'Read' || tool === 'Write' || tool === 'Edit' || tool === 'NotebookEdit') {
    renderCodeViewer(el, evt, tool, input);
  } else if (tool === 'Bash') {
    renderTerminalViewer(el, evt, input);
  } else if (tool === 'WebSearch') {
    renderBrowserSearch(el, evt, input);
  } else if (tool === 'WebFetch') {
    renderBrowserFetch(el, evt, input);
  } else if (tool === 'Grep' || tool === 'Glob') {
    renderSearchViewer(el, evt, tool, input);
  } else if (tool === 'Task') {
    renderAgentViewer(el, evt, input);
  } else {
    renderGenericViewer(el, evt, tool, input);
  }
}

function renderCodeViewer(el, evt, tool, input) {
  const filePath = input.file_path || 'untitled';
  const fileName = filePath.split(/[/\\]/).pop();
  const ext = fileName.split('.').pop().toLowerCase();

  let actionLabel = '';
  let actionColor = '';
  if (tool === 'Read') { actionLabel = 'READING'; actionColor = 'var(--accent-blue)'; }
  else if (tool === 'Edit') { actionLabel = 'EDITING'; actionColor = 'var(--accent-orange)'; }
  else if (tool === 'Write') { actionLabel = 'WRITING'; actionColor = 'var(--accent-green)'; }

  let codeHtml = '';
  if (tool === 'Edit') {
    // Show diff view
    const oldStr = input.old_string || '';
    const newStr = input.new_string || '';
    const oldLines = oldStr.split('\n');
    const newLines = newStr.split('\n');
    let lineNum = 1;
    codeHtml += oldLines.map(l =>
      `<div class="code-line diff-del"><span class="code-linenum">${lineNum++}</span><span class="code-text">- ${esc(l)}</span></div>`
    ).join('');
    codeHtml += newLines.map(l =>
      `<div class="code-line diff-add"><span class="code-linenum">${lineNum++}</span><span class="code-text">+ ${esc(l)}</span></div>`
    ).join('');
  } else if (tool === 'Write') {
    const content = input.content || '';
    const lines = content.split('\n');
    codeHtml = lines.map((l, i) =>
      `<div class="code-line diff-add"><span class="code-linenum">${i+1}</span><span class="code-text">${syntaxHL(l, ext)}</span></div>`
    ).join('');
  } else if (tool === 'Read') {
    // Show placeholder with file path
    const content = evt.tool_output || input.content || '';
    if (content) {
      const lines = (typeof content === 'string' ? content : JSON.stringify(content, null, 2)).split('\n').slice(0, 200);
      codeHtml = lines.map((l, i) =>
        `<div class="code-line"><span class="code-linenum">${i+1}</span><span class="code-text">${syntaxHL(l, ext)}</span></div>`
      ).join('');
    } else {
      for (let i = 1; i <= 20; i++) {
        const hl = (i >= 8 && i <= 12) ? ' highlight' : '';
        codeHtml += `<div class="code-line${hl}"><span class="code-linenum">${i}</span><span class="code-text">${i >= 8 && i <= 12 ? '<span class="syn-cm">  // reading...</span>' : ''}</span></div>`;
      }
    }
  }

  el.innerHTML = `<div class="viewer-code">
    <div class="code-titlebar">
      <div class="code-tab active"><span class="code-tab-icon">&#128196;</span> ${esc(fileName)}</div>
      <span class="code-action-label" style="color:${actionColor}">${actionLabel}</span>
    </div>
    <div class="code-body">${codeHtml}</div>
  </div>`;
}

function renderTerminalViewer(el, evt, input) {
  const cmd = input.command || '';
  const output = evt.tool_output || '';
  const desc = input.description || '';
  const outStr = typeof output === 'string' ? output : JSON.stringify(output, null, 2);

  el.innerHTML = `<div class="viewer-terminal">
    <div class="term-titlebar">
      <div class="term-dots"><span class="d-r"></span><span class="d-y"></span><span class="d-g"></span></div>
      <span class="term-title">${desc ? esc(desc) : 'Terminal'}</span>
    </div>
    <div class="term-body">
      <div><span class="term-prompt">$ </span><span class="term-cmd">${esc(cmd)}</span></div>
      ${outStr ? `<div class="term-output">${esc(trunc(outStr, 5000))}</div>` : `<div style="margin-top:8px"><span class="term-prompt">$ </span><span class="term-cursor"></span></div>`}
    </div>
  </div>`;
}

function renderBrowserSearch(el, evt, input) {
  const query = input.query || '';
  // Generate fake search results based on the query
  const results = [
    { url: `https://docs.example.com/search?q=${encodeURIComponent(query)}`, title: `${query} - Documentation`, desc: `Comprehensive guide and reference for <em>${esc(query)}</em>. Learn best practices, examples, and advanced usage patterns...` },
    { url: `https://stackoverflow.com/questions/...`, title: `How to ${query} - Stack Overflow`, desc: `Top answers about <em>${esc(query)}</em> from the developer community. Includes code examples and explanations...` },
    { url: `https://github.com/search?q=${encodeURIComponent(query)}`, title: `${query} repositories - GitHub`, desc: `Open source projects and code related to <em>${esc(query)}</em>. Browse implementations, libraries, and tools...` },
  ];

  el.innerHTML = `<div class="viewer-browser">
    <div class="browser-chrome">
      <div class="browser-controls">
        <button class="browser-nav-btn">&#8592;</button>
        <button class="browser-nav-btn">&#8594;</button>
        <button class="browser-nav-btn">&#8635;</button>
        <div class="browser-url-bar">
          <span class="lock">&#128274;</span>
          <span class="url"><span class="domain">google.com</span>/search?q=${esc(encodeURIComponent(query))}</span>
        </div>
      </div>
    </div>
    <div class="browser-body">
      <div class="search-logo">
        <span><span class="s-b">G</span><span class="s-r">o</span><span class="s-y">o</span><span class="s-b">g</span><span class="s-g">l</span><span class="s-r">e</span></span>
      </div>
      <div class="search-bar-fake">${esc(query)}</div>
      ${results.map(r => `<div class="search-result">
        <div class="sr-url">${esc(r.url)}</div>
        <div class="sr-title">${esc(r.title)}</div>
        <div class="sr-desc">${r.desc}</div>
      </div>`).join('')}
    </div>
  </div>`;
}

function renderBrowserFetch(el, evt, input) {
  const url = input.url || '';
  let host = '';
  try { host = new URL(url).hostname; } catch(e) { host = url; }
  const content = evt.tool_output || input.prompt || '';
  const contentStr = typeof content === 'string' ? content : JSON.stringify(content, null, 2);

  el.innerHTML = `<div class="viewer-browser">
    <div class="browser-chrome">
      <div class="browser-controls">
        <button class="browser-nav-btn">&#8592;</button>
        <button class="browser-nav-btn">&#8594;</button>
        <button class="browser-nav-btn">&#8635;</button>
        <div class="browser-url-bar">
          <span class="lock">&#128274;</span>
          <span class="url"><span class="domain">${esc(host)}</span>${esc(url.replace(/^https?:\/\/[^/]+/, ''))}</span>
        </div>
      </div>
    </div>
    <div class="browser-body" style="background:var(--bg-primary); color:var(--text-primary); font-family:inherit; font-size:12px; line-height:1.7;">
      <div style="color:var(--text-muted); margin-bottom:12px; font-size:11px;">Fetching: ${esc(url)}</div>
      ${contentStr ? `<pre style="white-space:pre-wrap; word-break:break-all;">${esc(trunc(contentStr, 3000))}</pre>` : '<div style="color:var(--text-muted);">Loading page content...</div>'}
    </div>
  </div>`;
}

function renderSearchViewer(el, evt, tool, input) {
  const pattern = input.pattern || '';
  const path = input.path || '.';
  const output = evt.tool_output || '';
  const outStr = typeof output === 'string' ? output : JSON.stringify(output, null, 2);
  const lines = outStr ? outStr.split('\n').filter(l => l.trim()).slice(0, 50) : [];

  el.innerHTML = `<div class="viewer-search">
    <div class="search-titlebar">
      <div class="search-input-fake">
        <span class="si-icon">&#128269;</span>
        <span style="color:var(--accent-purple); font-weight:600;">${esc(pattern)}</span>
      </div>
      <span class="search-scope">${tool === 'Glob' ? 'files' : 'content'}</span>
      <span class="search-scope">${esc(path)}</span>
    </div>
    <div class="search-body">
      ${lines.length ? lines.map(l => {
        return `<div class="search-match-line"><span class="sml-text">${highlightMatch(esc(l), pattern)}</span></div>`;
      }).join('') : `
        <div style="padding:40px; text-align:center; color:var(--text-muted);">
          <div style="font-size:24px; margin-bottom:8px;">&#128269;</div>
          <div>Searching for <strong style="color:var(--accent-purple);">${esc(pattern)}</strong></div>
          <div style="font-size:11px; margin-top:4px;">in ${esc(path)}</div>
        </div>
      `}
    </div>
  </div>`;
}

function renderAgentViewer(el, evt, input) {
  const desc = input.description || input.prompt || 'Running sub-agent...';
  const agentType = input.subagent_type || 'agent';
  el.innerHTML = `<div class="viewer-agent">
    <div class="agent-orb"></div>
    <div class="agent-desc">${esc(desc)}</div>
    <div class="agent-label">Sub-agent: ${esc(agentType)}</div>
    <div class="agent-label" style="color:var(--text-muted); font-size:11px;">Delegated task running autonomously...</div>
  </div>`;
}

function renderGenericViewer(el, evt, tool, input) {
  const color = TOOL_COLORS[tool] || 'var(--text-secondary)';
  const icon = TOOL_ICONS[tool] || '&#9670;';
  const entries = Object.entries(input);
  el.innerHTML = `<div style="padding:20px;">
    <div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:700;background:${color}22;color:${color};margin-bottom:16px;">
      ${icon} ${tool}
    </div>
    <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;overflow:hidden;">
      <div style="padding:10px 14px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);background:var(--bg-tertiary);border-bottom:1px solid var(--border);">Input</div>
      <div style="padding:14px;font-size:12px;line-height:1.6;">
        ${entries.map(([k,v]) => {
          const val = typeof v === 'string' ? v : JSON.stringify(v,null,2);
          return `<div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:var(--accent-purple);min-width:100px;flex-shrink:0;">${esc(k)}</span><span style="word-break:break-all;">${esc(trunc(val,2000))}</span></div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// ── Syntax Highlighting (basic) ─────────────
function syntaxHL(line, ext) {
  let s = esc(line);
  const pyLike = ['py','js','ts','tsx','jsx','java','go','rs','rb','sh','bash'];
  if (!pyLike.includes(ext)) return s;
  // Comments
  s = s.replace(/(\/\/.*)$/gm, '<span class="syn-cm">$1</span>');
  s = s.replace(/(#.*)$/gm, '<span class="syn-cm">$1</span>');
  // Strings
  s = s.replace(/(&quot;[^&]*&quot;)/g, '<span class="syn-str">$1</span>');
  s = s.replace(/(&#39;[^&]*&#39;)/g, '<span class="syn-str">$1</span>');
  // Keywords
  const kws = ['def','class','import','from','return','if','else','elif','for','while','try','except','finally','with','as','async','await','function','const','let','var','export','async','yield','raise','pass','break','continue','in','not','and','or','is','True','False','None','true','false','null','self','this','fn','pub','use','mod','struct','impl','trait','func','package','type','interface'];
  kws.forEach(kw => {
    const re = new RegExp('\\b(' + kw + ')\\b', 'g');
    s = s.replace(re, '<span class="syn-kw">$1</span>');
  });
  // Numbers
  s = s.replace(/\b(\d+\.?\d*)\b/g, '<span class="syn-num">$1</span>');
  return s;
}

function highlightMatch(text, pattern) {
  if (!pattern) return text;
  try {
    const re = new RegExp('(' + pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
    return text.replace(re, '<span class="match-hl">$1</span>');
  } catch(e) { return text; }
}

// ── Stats ───────────────────────────────────
function renderStats() {
  document.getElementById('stat-total').textContent = allEvents.length;
  const allFiles = new Set([...filesRead, ...filesWritten]);
  document.getElementById('stat-files').textContent = allFiles.size;
  document.getElementById('sc-reads').textContent = toolCounts['Read'] || 0;
  document.getElementById('sc-writes').textContent = (toolCounts['Edit'] || 0) + (toolCounts['Write'] || 0);
  document.getElementById('sc-bash').textContent = toolCounts['Bash'] || 0;
  document.getElementById('sc-searches').textContent = (toolCounts['Grep'] || 0) + (toolCounts['Glob'] || 0);
  if (sessionStart) {
    const secs = Math.floor((Date.now() - sessionStart) / 1000);
    const m = Math.floor(secs / 60); const s = secs % 60;
    document.getElementById('stat-uptime').textContent = m > 0 ? `${m}m ${s}s` : `${s}s`;
  }
}
function renderToolChart() {
  const el = document.getElementById('tool-chart');
  const entries = Object.entries(toolCounts).sort((a,b) => b[1]-a[1]).slice(0,8);
  const max = entries.length ? entries[0][1] : 1;
  el.innerHTML = entries.map(([tool,count]) => {
    const color = TOOL_COLORS[tool] || 'var(--text-muted)';
    const pct = Math.round((count/max)*100);
    return `<div class="tool-bar"><div class="tool-bar-name">${tool}</div><div class="tool-bar-track"><div class="tool-bar-fill" style="width:${pct}%;background:${color}"></div></div><div class="tool-bar-count">${count}</div></div>`;
  }).join('');
}
function renderFileTree() {
  const el = document.getElementById('file-tree');
  const allFiles = [];
  filesWritten.forEach(f => allFiles.push({path:f,type:'write'}));
  filesRead.forEach(f => { if(!filesWritten.has(f)) allFiles.push({path:f,type:'read'}); });
  document.getElementById('files-count').textContent = allFiles.length;
  el.innerHTML = allFiles.slice(-40).reverse().map(f => {
    const cls = f.type==='write' ? 'ft-write' : 'ft-read';
    const icon = f.type==='write' ? '&#9998;' : '&#128196;';
    const short = f.path.length > 35 ? '...'+f.path.slice(-32) : f.path;
    return `<div class="file-tree-item ${cls}"><span class="ft-icon">${icon}</span><span class="ft-path" title="${esc(f.path)}">${esc(short)}</span></div>`;
  }).join('');
}

// ── Helpers ──────────────────────────────────
function getEventSummary(evt) {
  const i = evt.tool_input || {}, t = evt.tool_name;
  if (t==='Read' && i.file_path) return i.file_path;
  if (t==='Edit' && i.file_path) return i.file_path;
  if (t==='Write' && i.file_path) return i.file_path;
  if (t==='Bash' && i.command) return i.command.slice(0,80);
  if (t==='Grep' && i.pattern) return `/${i.pattern}/`;
  if (t==='Glob' && i.pattern) return i.pattern;
  if (t==='Task' && i.description) return i.description;
  if (t==='WebFetch' && i.url) return i.url;
  if (t==='WebSearch' && i.query) return i.query;
  return JSON.stringify(i).slice(0,60);
}
function formatTime(ts) { return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function trunc(s, max) { return s.length > max ? s.slice(0,max)+'\n...(truncated)' : s; }

// ── Token Usage ─────────────────────────────
const TOKEN_PRICES = {
  // per million tokens (USD)
  'claude-opus-4-6':   { input: 15, output: 75, cache_write: 18.75, cache_read: 1.50 },
  'claude-sonnet-4-6': { input: 3,  output: 15, cache_write: 3.75,  cache_read: 0.30 },
  'claude-haiku-4-5':  { input: 0.80, output: 4, cache_write: 1.00, cache_read: 0.08 },
};

function getPrice(model) {
  if (!model) return TOKEN_PRICES['claude-opus-4-6'];
  for (const key of Object.keys(TOKEN_PRICES)) {
    if (model.startsWith(key) || model.includes(key)) return TOKEN_PRICES[key];
  }
  if (model.includes('opus')) return TOKEN_PRICES['claude-opus-4-6'];
  if (model.includes('sonnet')) return TOKEN_PRICES['claude-sonnet-4-6'];
  if (model.includes('haiku')) return TOKEN_PRICES['claude-haiku-4-5'];
  return TOKEN_PRICES['claude-opus-4-6'];
}

function fmtTokens(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
  return String(n);
}

let lastUsage = null;

async function fetchUsage() {
  try {
    const res = await fetch('/api/usage');
    if (!res.ok) return;
    lastUsage = await res.json();
    renderUsage();
  } catch(e) {}
}

function renderUsage() {
  const el = document.getElementById('usage-section');
  if (!lastUsage || lastUsage.error) {
    el.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:11px;padding:8px 0;">Waiting for data...</div>';
    return;
  }
  const u = lastUsage;
  const prices = getPrice(u.model);

  // Calculate cost
  const cost = (
    (u.input_tokens / 1_000_000) * prices.input +
    (u.output_tokens / 1_000_000) * prices.output +
    (u.cache_creation_input_tokens / 1_000_000) * prices.cache_write +
    (u.cache_read_input_tokens / 1_000_000) * prices.cache_read
  );

  // Ring: output tokens as proportion of total (visual indicator)
  const outPct = u.total_tokens > 0 ? Math.min((u.output_tokens / u.total_tokens) * 100, 100) : 0;
  const circumference = 2 * Math.PI * 30;
  const inOffset = circumference - (circumference * Math.min(((u.input_tokens + u.cache_creation_input_tokens) / Math.max(u.total_tokens,1)) * 100, 100) / 100);
  const outOffset = circumference - (circumference * outPct / 100);
  const cacheOffset = circumference - (circumference * Math.min((u.cache_read_input_tokens / Math.max(u.total_tokens,1)) * 100, 100) / 100);

  const modelShort = u.model ? u.model.replace('claude-', '').replace(/-\d{8}$/, '') : 'unknown';

  el.innerHTML = `
    <div class="usage-ring-row">
      <div class="usage-ring-wrap">
        <svg width="72" height="72" viewBox="0 0 72 72">
          <circle class="usage-ring-bg" cx="36" cy="36" r="30"/>
          <circle class="usage-ring-fill" cx="36" cy="36" r="30"
            stroke="var(--accent-purple)"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${cacheOffset}"/>
          <circle class="usage-ring-fill" cx="36" cy="36" r="24"
            stroke="var(--accent-blue)" stroke-width="5"
            stroke-dasharray="${circumference * 24/30}"
            stroke-dashoffset="${(circumference * 24/30) - ((circumference * 24/30) * Math.min(((u.input_tokens + u.cache_creation_input_tokens) / Math.max(u.total_tokens,1)) * 100, 100) / 100)}"/>
          <circle class="usage-ring-fill" cx="36" cy="36" r="18"
            stroke="var(--accent-green)" stroke-width="4"
            stroke-dasharray="${circumference * 18/30}"
            stroke-dashoffset="${(circumference * 18/30) - ((circumference * 18/30) * outPct / 100)}"/>
        </svg>
        <div class="usage-ring-center">
          <div class="usage-ring-value">${fmtTokens(u.total_tokens)}</div>
          <div class="usage-ring-unit">tokens</div>
        </div>
      </div>
      <div class="usage-breakdown">
        <div class="usage-row"><span class="usage-row-label" style="color:var(--accent-blue);">Input</span><span class="usage-row-value">${fmtTokens(u.input_tokens)}</span></div>
        <div class="usage-row"><span class="usage-row-label" style="color:var(--accent-green);">Output</span><span class="usage-row-value">${fmtTokens(u.output_tokens)}</span></div>
        <div class="usage-row"><span class="usage-row-label" style="color:var(--accent-purple);">Cache read</span><span class="usage-row-value">${fmtTokens(u.cache_read_input_tokens)}</span></div>
        <div class="usage-row"><span class="usage-row-label" style="color:var(--accent-orange);">Cache write</span><span class="usage-row-value">${fmtTokens(u.cache_creation_input_tokens)}</span></div>
        <div class="usage-row"><span class="usage-row-label">API calls</span><span class="usage-row-value">${u.api_messages}</span></div>
      </div>
    </div>
    <div style="text-align:center;">
      <span class="usage-model-badge">${esc(modelShort)}</span>
    </div>
    <div class="usage-cost">$${cost.toFixed(2)}</div>
    <div class="usage-cost-label">Est. session cost</div>
  `;
}

// ── Conversation ────────────────────────────
let conversationMessages = [];
let chatAutoScroll = true;

async function fetchConversation() {
  try {
    const res = await fetch('/api/conversation');
    if (!res.ok) return;
    const data = await res.json();
    if (data.messages && data.messages.length !== conversationMessages.length) {
      conversationMessages = data.messages;
      renderConversation();
    }
  } catch(e) {}
}

function renderConversation() {
  const el = document.getElementById('chat-messages');
  document.getElementById('chat-count').textContent = conversationMessages.length;

  if (!conversationMessages.length) {
    el.innerHTML = '<div class="chat-empty">Waiting for conversation...</div>';
    return;
  }

  const wasAtBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 60;

  el.innerHTML = conversationMessages.map(msg => {
    const cls = msg.role === 'user' ? 'user' : 'assistant';
    const roleLabel = msg.role === 'user' ? 'You' : 'Claude';
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '';
    const rendered = renderMarkdown(msg.text);
    return `<div class="chat-msg ${cls}">
      <div class="chat-msg-role">${roleLabel}</div>
      <div class="chat-msg-text">${rendered}</div>
      ${time ? `<div class="chat-msg-time">${time}</div>` : ''}
    </div>`;
  }).join('');

  // Add typing indicator if last message was from user
  const last = conversationMessages[conversationMessages.length - 1];
  if (last && last.role === 'user') {
    el.innerHTML += `<div class="chat-typing">
      <div class="chat-typing-dot"></div>
      <div class="chat-typing-dot"></div>
      <div class="chat-typing-dot"></div>
    </div>`;
  }

  if (wasAtBottom || chatAutoScroll) {
    el.scrollTop = el.scrollHeight;
  }
}

function renderMarkdown(text) {
  let s = esc(text);
  // Code blocks: ```...```
  s = s.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    return `<pre>${code}</pre>`;
  });
  // Inline code: `...`
  s = s.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  // Bold: **...**
  s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Headers: **text** at start of line (already handled by bold)
  // Bullet points
  s = s.replace(/^(\s*)[-*] (.+)$/gm, '$1<span style="color:var(--accent-blue);">&#8226;</span> $2');
  // Links: [text](url) — just show text
  s = s.replace(/\[([^\]]+)\]\([^)]+\)/g, '<span style="color:var(--accent-blue);text-decoration:underline;">$1</span>');
  return s;
}

setInterval(() => {
  if (sessionStart) {
    const secs = Math.floor((Date.now()-sessionStart)/1000);
    const m = Math.floor(secs/60); const s = secs%60;
    document.getElementById('stat-uptime').textContent = m>0 ? `${m}m ${s}s` : `${s}s`;
  }
}, 1000);

// Poll usage and conversation
setInterval(fetchUsage, 3000);
setInterval(fetchConversation, 2000);

connect();
fetchUsage();
fetchConversation();
</script>
</body>
</html>
